extends layout

block content
  a(href='/') ← Back
  h1 Compose
  .card
    form#create-form
      label Input Markdown IDs (comma separated)
        input(name='inputMarkdownIds', required)
      label Format
        select(name='format', id='format-select')
          option(value='side-by-side') side-by-side
          option(value='paragraph-by-paragraph') paragraph-by-paragraph
          option(value='sentence-by-sentence') sentence-by-sentence
          option(value='translated-only') translated-only
      button(type='submit') Create Compose Job
      span#status
  .card
    h3 Jobs
    button#refresh-jobs Refresh
    table
      thead
        tr
          th Job ID
          th Inputs
          th Format
          th Status
          th Output Path
          th Created
      tbody#jobs
  .card
    h3 Composed Markdown
    button#refresh-md Refresh
    table
      thead
        tr
          th Job ID
          th Path
          th Created
      tbody#markdowns
  script.
    async function applyFormatOptions() {
      try {
        const res = await fetch('/api/settings/');
        const data = await res.json();
        const opts = data.dropdownOptions && data.dropdownOptions.formatOptions;
        if (Array.isArray(opts) && opts.length) {
          const sel = document.getElementById('format-select');
          sel.innerHTML = opts.map(o => `<option value="${o}">${o}</option>`).join('');
        }
      } catch {}
    }
    async function listJobs() {
      const res = await fetch('/api/compose/jobs');
      const data = await res.json();
      document.getElementById('jobs').innerHTML = (data.items||[]).map(j => `<tr><td>${j.jobId}</td><td>${(j.inputs||[]).join(', ')}</td><td>${j.format}</td><td>${j.status}</td><td>${j.outputPath||''}</td><td>${new Date(j.createdAt).toLocaleString()}</td></tr>`).join('');
    }
    async function listMarkdowns() {
      const res = await fetch('/api/compose/markdowns');
      const data = await res.json();
      document.getElementById('markdowns').innerHTML = (data.items||[]).map(m => `<tr><td>${m.jobId}</td><td>${m.path}</td><td>${new Date(m.createdAt).toLocaleString()}</td></tr>`).join('');
    }
    document.getElementById('refresh-jobs').addEventListener('click', listJobs);
    document.getElementById('refresh-md').addEventListener('click', listMarkdowns);
    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = { inputMarkdownIds: String(fd.get('inputMarkdownIds')).split(',').map(s=>s.trim()), format: fd.get('format') };
      document.getElementById('status').textContent = 'Creating…';
      try {
        const res = await fetch('/api/compose/jobs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('Create failed');
        await res.json();
        document.getElementById('status').textContent = 'Created';
        await listJobs();
        await listMarkdowns();
      } catch (err) {
        document.getElementById('status').textContent = '';
        alert(err.message || 'Error creating compose job');
      }
    });
    applyFormatOptions();
    listJobs();
    listMarkdowns();