extends layout

block content
  a(href='/') ← Back
  script(src='/assets/mail.js')
          th Count
      tbody#emails
  script.
    async function listJobs() {
      const res = await fetch('/api/send-mail/jobs');
      const data = await res.json();
      document.getElementById('jobs').innerHTML = (data.items||[]).map(j => `<tr><td>${j.jobId}</td><td>${j.email}</td><td>${j.template}</td><td>${j.status}</td><td>${new Date(j.createdAt).toLocaleString()}</td></tr>`).join('');
    }
    async function listEmails(q) {
      const res = await fetch('/api/send-mail/emails' + (q?`?q=${encodeURIComponent(q)}`:''));
      const data = await res.json();
      document.getElementById('emails').innerHTML = (data.items||[]).map(e => `<tr><td>${e.email}</td><td>${new Date(e.lastUsedAt).toLocaleString()}</td><td>${e.count}</td></tr>`).join('');
    }
    document.getElementById('refresh-jobs').addEventListener('click', listJobs);
    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      if (!body.epubPath) delete body.epubPath;
      document.getElementById('status').textContent = 'Queuing…';
      try {
        const res = await fetch('/api/send-mail/jobs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('Create failed');
        await res.json();
        document.getElementById('status').textContent = 'Queued';
        await listJobs();
      } catch (err) {
        document.getElementById('status').textContent = '';
        alert(err.message || 'Error queuing mail');
      }
    });
    document.getElementById('emails-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = new FormData(e.target).get('q');
      listEmails(q);
    });
    listJobs();
    listEmails();